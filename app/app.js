// Generated by CoffeeScript 1.10.0

/*
Author: Jason Gwartz
2016
 */
var LoadedSample, PlaySound, SoundContainer, context, main, sample_urls, samples, startPlayback, t, track;

sample_urls = ["../samples/drum_bass_hard.wav", "../samples/drum_snare_hard.wav", "../samples/drum_cymbal_closed.wav"];

context = null;

samples = null;

t = null;

LoadedSample = (function() {
  function LoadedSample(file) {
    var request, self;
    this.file = file;
    request = new XMLHttpRequest();
    request.open('GET', this.file, true);
    request.responseType = 'arraybuffer';
    self = this;
    request.onload = function() {
      return self.data = request.response;
    };
    request.send();
  }

  LoadedSample.prototype.play = function(n) {
    return context.decodeAudioData(this.data, function(decoded) {
      this.source = context.createBufferSource();
      this.source.buffer = decoded;
      this.source.connect(context.destination);
      return this.source.start(n);
    }, null);
  };

  return LoadedSample;

})();

PlaySound = (function() {
  function PlaySound(sample, beat) {
    this.sample = sample;
    this.beat = beat;
  }

  return PlaySound;

})();

SoundContainer = (function() {
  function SoundContainer() {
    this.buffer = [];
  }

  SoundContainer.prototype.prepare = function() {
    var i, index, inputs, j, loaded, n, ref, results, v;
    t = context.currentTime;
    loaded = true;
    [
      (function() {
        var j, len, results;
        results = [];
        for (j = 0, len = samples.length; j < len; j++) {
          i = samples[j];
          results.push(i.data === void 0 ? loaded = false : void 0);
        }
        return results;
      })()
    ];
    if (!loaded) {
      return alert("Samples still loading, please wait.");
    } else {
      inputs = (function() {
        var j, len, ref, results;
        ref = ["bd", "sd", "cym"];
        results = [];
        for (j = 0, len = ref.length; j < len; j++) {
          v = ref[j];
          results.push(document.getElementById(v).value.split(' '));
        }
        return results;
      })();
      results = [];
      for (index = j = 0, ref = inputs.length; 0 <= ref ? j < ref : j > ref; index = 0 <= ref ? ++j : --j) {
        results.push((function() {
          var k, len, ref1, results1;
          ref1 = inputs[index];
          results1 = [];
          for (k = 0, len = ref1.length; k < len; k++) {
            n = ref1[k];
            if (function(n) {
              return n === !NaN;
            }) {
              results1.push(this.add(new PlaySound(samples[index], t + parseFloat(n))));
            }
          }
          return results1;
        }).call(this));
      }
      return results;
    }
  };

  SoundContainer.prototype.add = function(p) {
    return this.buffer.push(p);
  };

  SoundContainer.prototype.play = function() {
    var i, j, len, ref, results;
    ref = this.buffer;
    results = [];
    for (j = 0, len = ref.length; j < len; j++) {
      i = ref[j];
      results.push(i.sample.play(i.beat));
    }
    return results;
  };

  return SoundContainer;

})();

startPlayback = function() {
  var track;
  track = new SoundContainer();
  track.prepare();
  return track.play();
};

track = null;

main = function() {
  var i, j, len, ready, results;
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  context = new AudioContext();
  samples = (function() {
    var j, len, results;
    results = [];
    for (j = 0, len = sample_urls.length; j < len; j++) {
      i = sample_urls[j];
      results.push(new LoadedSample(i));
    }
    return results;
  })();
  results = [];
  while (true) {
    console.log("in");
    ready = true;
    for (j = 0, len = samples.length; j < len; j++) {
      i = samples[j];
      if (i.data === void 0) {
        (function() {
          ready = false;
          console.log("not ready");
          return setTimeout((function() {}), 0.5);
        });
      }
    }
    if (ready) {
      console.log("ready");
      break;
    } else {
      results.push(void 0);
    }
  }
  return results;
};

main();
